name: PR - Build / Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Code
            uses: actions/checkout@v4
        
          - name: Setup .Net Core
            uses: actions/setup-dotnet@v4.1.0
            with:
              dotnet-version: 8.0.x
            
          - name: Restore Dependencies
            run: dotnet restore "${{ github.workspace }}/src/my-web-app.sln"
            
          - name: Build
            run: dotnet build "${{ github.workspace }}/src/my-web-app.sln" --no-restore --configuration Release
            
          - name: Test
            run: dotnet test "${{ github.workspace }}/src/my-web-app.sln" --no-restore --logger:"junit:LogfilePath=${{ github.workspace }}/test-results/test-results.xml;
            
          - name: Create test summary
            uses: test-summary/action@v2.4
            with:
              paths: ${{ github.workspace }}/results/*.xml
              output: ${{ github.workspace }}/results/summary.md
              show: all
            if: always()
            
          - name: Add test results to Job Summary
            run: |
              echo "TEST RESULTS:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat "${{ github.workspace }}/results/summary.md" >> $GITHUB_STEP_SUMMARY
            if: always()
            
          - name: Publish
            run: dotnet publish "${{ github.workflow_dispatch}}/src/my-web-app/my-web-app.csproj" -c Release -o mywebapp
            
          - name: Upload build artifact
            uses: actions/upload-artifact@v2
            with:
              name: myapp
              path: mywebapp/**
              if-no-files-found: error
            